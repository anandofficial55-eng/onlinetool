<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Editor Pro - Free Online PDF Editor | Edit, Annotate & Sign PDFs</title>
    <meta name="description" content="Edit PDF files online for free. Add text, images, shapes, signatures, and clickable links to your PDFs. No registration required.">
    <meta name="keywords" content="PDF editor, edit PDF, online PDF editor, free PDF editor, annotate PDF, sign PDF">
    <meta name="author" content="PDF Editor Pro">
    <meta name="robots" content="index, follow">
    <meta property="og:type" content="website">
    <meta property="og:title" content="PDF Editor Pro - Free Online PDF Editor">
    <meta property="og:description" content="Edit PDF files online for free. Add text, images, shapes, signatures, and clickable links.">
    <link rel="canonical" href="https://pdfeditor.pro">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"WebApplication","name":"PDF Editor Pro","description":"Free online PDF editor","applicationCategory":"ProductivityApplication","offers":{"@type":"Offer","price":"0"}}</script>
    <style>
        :root{--primary:#7c3aed;--primary-dark:#6d28d9;--primary-light:#a78bfa;--accent:#7c3aed;--bg-cream:#fafafa;--bg-warm:#f5f3ff;--bg-soft:#f3f4f6;--text-dark:#1a1a2e;--text-mid:#4a5568;--text-light:#718096;--border:#e5e7eb;--shadow:0 4px 20px rgba(124,58,237,0.08);--shadow-lg:0 20px 60px rgba(124,58,237,0.12);--radius:12px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:var(--bg-cream);color:var(--text-dark);line-height:1.6}
        .bg-pattern{position:fixed;inset:0;background-image:radial-gradient(circle at 20% 80%,rgba(124,58,237,0.05) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(167,139,250,0.05) 0%,transparent 50%);pointer-events:none;z-index:0}
        .header{position:sticky;top:0;background:rgba(254,252,248,0.9);backdrop-filter:blur(20px);padding:14px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);z-index:100}
        .logo{display:flex;align-items:center;gap:12px;text-decoration:none}
        .logo-icon{width:44px;height:44px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 4px 15px rgba(255,107,53,0.3)}
        .logo-text{font-family:'Playfair Display',serif;font-size:24px;font-weight:700;color:var(--text-dark)}
        .logo-text span{color:var(--primary)}
        .btn{padding:12px 24px;border-radius:var(--radius);font-size:14px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all 0.3s ease;display:inline-flex;align-items:center;gap:8px}
        .btn-ghost{background:transparent;color:var(--text-mid);border:2px solid var(--border)}
        .btn-ghost:hover{background:var(--bg-soft);transform:translateY(-2px)}
        .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;box-shadow:0 4px 15px rgba(124,58,237,0.35)}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(124,58,237,0.45)}
        .btn-success{background:linear-gradient(135deg,#10b981,#059669);color:white;box-shadow:0 4px 15px rgba(16,185,129,0.35)}
        .btn-success:hover{transform:translateY(-2px)}
        #uploadScreen{min-height:100vh;display:flex;flex-direction:column;position:relative;z-index:1}
        .upload-container{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 20px}
        .upload-card{background:white;border-radius:24px;padding:50px;text-align:center;max-width:560px;width:100%;box-shadow:var(--shadow-lg);position:relative;overflow:hidden}
        .upload-card::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,var(--primary),var(--primary-light),var(--primary));background-size:200% 100%;animation:shimmer 3s ease-in-out infinite}
        @keyframes shimmer{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
        .upload-emoji{font-size:64px;margin-bottom:20px;display:inline-block;animation:float 3s ease-in-out infinite}
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .upload-card h1{font-family:'Playfair Display',serif;font-size:32px;margin-bottom:12px}
        .upload-card>p{color:var(--text-light);font-size:16px;margin-bottom:30px}
        .upload-area{border:3px dashed var(--border);border-radius:16px;padding:45px 25px;cursor:pointer;margin-bottom:25px;transition:all 0.3s;background:var(--bg-warm)}
        .upload-area:hover{border-color:var(--primary);background:linear-gradient(135deg,rgba(124,58,237,0.05),rgba(167,139,250,0.05));transform:scale(1.01)}
        .upload-area-icon{width:60px;height:60px;background:linear-gradient(135deg,var(--primary-light),var(--primary));border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:26px;box-shadow:0 8px 25px rgba(124,58,237,0.3)}
        .upload-area h3{font-size:17px;margin-bottom:6px}
        .upload-area p{font-size:14px;color:var(--text-light)}
        .features-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:30px;padding-top:25px;border-top:1px solid var(--border)}
        .feature-item{padding:14px 8px;background:var(--bg-soft);border-radius:var(--radius);transition:all 0.3s}
        .feature-item:hover{background:#f5f3ff;transform:translateY(-3px)}
        .feature-item span{display:block;font-size:22px;margin-bottom:4px}
        .feature-item p{font-size:11px;color:var(--text-mid);font-weight:500}
        .other-tools{margin-top:30px;padding-top:20px;border-top:1px solid var(--border)}
        .other-tools h4{font-size:11px;color:var(--text-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
        .tools-links{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
        .tool-link{padding:8px 16px;background:white;border:1px solid var(--border);border-radius:50px;text-decoration:none;color:var(--text-mid);font-size:12px;font-weight:500;transition:all 0.3s}
        .tool-link:hover{border-color:var(--primary);color:var(--primary);transform:translateY(-2px)}
        #editorScreen{display:none;height:100vh;flex-direction:column;position:relative;z-index:1}
        .toolbar{background:white;padding:10px 16px;display:flex;align-items:center;gap:6px;border-bottom:1px solid var(--border);flex-wrap:wrap;box-shadow:var(--shadow)}
        .tool-btn{padding:9px 14px;border:2px solid transparent;border-radius:8px;background:var(--bg-soft);cursor:pointer;font-size:13px;font-weight:500;display:flex;align-items:center;gap:5px;font-family:inherit;color:var(--text-mid);transition:all 0.2s;white-space:nowrap}
        .tool-btn:hover{background:var(--bg-warm);border-color:var(--border)}
        .tool-btn.active{background:linear-gradient(135deg,rgba(124,58,237,0.1),rgba(124,58,237,0.15));border-color:var(--primary);color:var(--primary)}
        .tool-btn.danger{color:#e53e3e}
        .tool-btn.danger:hover{background:#fff5f5}
        .divider{width:1px;height:30px;background:var(--border);margin:0 6px}
        .color-wrap{position:relative}
        .color-btn{width:34px;height:34px;border-radius:8px;border:3px solid var(--border);cursor:pointer;transition:all 0.2s}
        .color-btn:hover{transform:scale(1.1)}
        .color-menu{position:absolute;top:calc(100% + 8px);left:0;background:white;border:1px solid var(--border);border-radius:var(--radius);padding:12px;display:none;box-shadow:var(--shadow-lg);z-index:100}
        .color-menu.show{display:block;animation:fadeIn 0.2s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
        .color-grid{display:grid;grid-template-columns:repeat(6,26px);gap:5px}
        .color-swatch{width:26px;height:26px;border-radius:6px;cursor:pointer;transition:all 0.2s;border:2px solid transparent}
        .color-swatch:hover{transform:scale(1.15)}
        .toolbar select{padding:9px 12px;border:2px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;background:var(--bg-soft);cursor:pointer}
        .toolbar select:focus{outline:none;border-color:var(--primary)}
        .page-nav{display:flex;align-items:center;gap:6px;margin-left:auto}
        .nav-btn{width:34px;height:34px;border:2px solid var(--border);border-radius:8px;background:white;cursor:pointer;font-size:14px;color:var(--text-mid);transition:all 0.2s;display:flex;align-items:center;justify-content:center}
        .nav-btn:hover:not(:disabled){border-color:var(--primary);color:var(--primary)}
        .nav-btn:disabled{opacity:0.4;cursor:not-allowed}
        .page-info,.zoom-info{min-width:50px;text-align:center;font-size:12px;font-weight:600;color:var(--text-mid);background:var(--bg-soft);padding:7px 10px;border-radius:8px}
        .editor-main{display:flex;flex:1;overflow:hidden}
        .sidebar{width:120px;background:var(--bg-soft);border-right:1px solid var(--border);padding:10px;overflow-y:auto}
        .thumb{background:white;border:3px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;overflow:hidden;transition:all 0.2s}
        .thumb:hover{border-color:var(--primary-light)}
        .thumb.active{border-color:var(--primary);box-shadow:0 4px 15px rgba(124,58,237,0.25)}
        .thumb img{width:100%;display:block}
        .thumb-num{text-align:center;padding:5px;font-size:10px;font-weight:600;color:var(--text-mid);background:var(--bg-soft)}
        .canvas-area{flex:1;background:linear-gradient(135deg,#5a6478,#4a5568);overflow:auto;display:flex;justify-content:center;align-items:flex-start;padding:20px}
        .canvas-wrap{position:relative;background:white;box-shadow:var(--shadow-lg);border-radius:4px}
        #pdfCanvas{display:block}
        #editCanvas{position:absolute;top:0;left:0}
        .selection-rect{position:absolute;border:2px dashed var(--primary);background:rgba(124,58,237,0.1);pointer-events:none;display:none;border-radius:4px}
        .text-overlay{position:absolute;display:none;z-index:20}
        .text-overlay.show{display:block}
        .text-overlay textarea{border:2px solid var(--primary);padding:6px 8px;font-family:inherit;outline:none;resize:none;background:rgba(255,255,255,0.98);border-radius:8px;box-shadow:var(--shadow)}
        .link-popup{position:fixed;display:none;z-index:1000;background:white;border-radius:20px;box-shadow:var(--shadow-lg);padding:28px;width:380px;max-width:90vw;border:2px solid var(--primary);top:50%;left:50%;transform:translate(-50%,-50%)}
        .link-popup.show{display:block;animation:popIn 0.3s}
        @keyframes popIn{from{opacity:0;transform:translate(-50%,-50%) scale(0.9)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
        .link-popup h4{font-size:18px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
        .link-popup>p{font-size:13px;color:var(--text-light);margin-bottom:16px}
        .link-popup input{width:100%;padding:14px;border:2px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit;margin-bottom:18px}
        .link-popup input:focus{border-color:var(--primary);outline:none}
        .link-popup-btns{display:flex;gap:10px;justify-content:flex-end}
        .right-panel{width:200px;background:white;border-left:1px solid var(--border);padding:16px;overflow-y:auto}
        .panel-title{font-size:10px;color:var(--text-light);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;font-weight:700}
        .element-item{padding:10px 12px;background:var(--bg-soft);border-radius:8px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;font-size:12px;cursor:pointer;transition:all 0.2s;border:2px solid transparent}
        .element-item:hover{background:var(--bg-warm)}
        .element-item.selected{background:rgba(124,58,237,0.1);border-color:var(--primary)}
        .del-btn{width:22px;height:22px;border:none;background:#fee2e2;color:#dc2626;border-radius:6px;cursor:pointer;font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .del-btn:hover{background:#dc2626;color:white}
        .help-box{margin-top:20px;padding:14px;background:linear-gradient(135deg,rgba(124,58,237,0.08),rgba(167,139,250,0.05));border-radius:var(--radius);font-size:11px;color:var(--text-mid);line-height:1.7;border:1px solid var(--border)}
        .help-box strong{color:var(--primary)}
        .help-box ul{list-style:none;margin-top:8px}
        .help-box li{padding:3px 0 3px 14px;position:relative}
        .help-box li::before{content:'‚Üí';position:absolute;left:0;color:var(--primary)}
        .bottom-bar{background:white;padding:10px 20px;border-top:1px solid var(--border);display:flex;gap:16px;align-items:center;font-size:12px}
        .bottom-bar span{color:var(--text-light)}
        .bottom-bar a{color:var(--primary);text-decoration:none;font-weight:500}
        .bottom-bar a:hover{color:var(--primary-dark)}
        .modal-bg{position:fixed;inset:0;background:rgba(26,26,46,0.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1000}
        .modal-bg.show{display:flex}
        .modal{background:white;border-radius:20px;padding:28px;width:90%;max-width:400px;box-shadow:var(--shadow-lg);animation:popIn 0.3s}
        .modal h3{font-size:20px;margin-bottom:18px;display:flex;align-items:center;gap:10px}
        .modal-btns{display:flex;gap:10px;justify-content:flex-end;margin-top:18px}
        .sig-canvas{width:100%;height:150px;border:2px solid var(--border);border-radius:var(--radius);cursor:crosshair;background:#fefefe}
        .loading{position:fixed;inset:0;background:rgba(254,252,248,0.95);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:2000}
        .loading.show{display:flex}
        .spinner{width:50px;height:50px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading p{margin-top:16px;color:var(--text-mid);font-weight:500}
        .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:#2d3a4f;color:white;padding:14px 26px;border-radius:50px;font-size:13px;font-weight:500;display:none;z-index:500;box-shadow:var(--shadow)}
        .toast.show{display:block;animation:toastIn 0.3s forwards}
        @keyframes toastIn{from{transform:translateX(-50%) translateY(20px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
        @media(max-width:768px){.header{padding:12px 16px}.logo-text{font-size:20px}.logo-icon{width:38px;height:38px;font-size:18px}.btn{padding:10px 14px;font-size:13px}.btn .btn-text{display:none}.upload-card{padding:28px 22px}.upload-card h1{font-size:26px}.upload-emoji{font-size:52px}.features-grid{grid-template-columns:repeat(2,1fr)}.toolbar{padding:8px 10px;gap:4px}.tool-btn{padding:8px 10px;font-size:12px}.tool-btn .tool-text{display:none}.divider{display:none}.sidebar{width:65px;padding:6px}.right-panel{display:none}.canvas-area{padding:12px}.bottom-bar{display:none}}
        @media(max-width:480px){.upload-card{padding:22px 16px;border-radius:16px}.upload-card h1{font-size:22px}.upload-area{padding:30px 15px}.features-grid{gap:8px}.feature-item{padding:10px 6px}.feature-item span{font-size:18px}.feature-item p{font-size:10px}.toolbar{gap:3px}.tool-btn{padding:7px 8px}.nav-btn{width:30px;height:30px}.sidebar{width:50px}.thumb-num{font-size:9px;padding:3px}}
        *:focus-visible{outline:3px solid var(--primary);outline-offset:2px}
        ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:var(--bg-soft)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:var(--text-light)}
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    <div class="loading" id="loading"><div class="spinner"></div><p id="loadingText">Loading...</p></div>
    <div class="toast" id="toast"></div>
    <main id="uploadScreen">
        <header class="header"><a href="/" class="logo"><div class="logo-icon"><i data-lucide="file-pen" style="width:24px;height:24px;color:white"></i></div><div class="logo-text">PDF <span>Editor</span></div></a></header>
        <div class="upload-container">
            <article class="upload-card">
                <div class="upload-emoji"><i data-lucide="file-text" style="width:72px;height:72px;color:var(--primary)"></i></div>
                <h1>Edit PDF Files Online</h1>
                <p>Add text, links, images, shapes & signatures ‚Äî completely free</p>
                <div class="upload-area" id="uploadArea" tabindex="0">
                    <input type="file" id="fileInput" accept=".pdf" style="display:none">
                    <div class="upload-area-icon"><i data-lucide="upload" style="width:28px;height:28px;color:white"></i></div>
                    <h3>Drop your PDF here</h3>
                    <p>or click to browse files</p>
                </div>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()"><i data-lucide="folder-open" style="width:18px;height:18px"></i> Select PDF File</button>
                <div class="features-grid">
                    <div class="feature-item"><span><i data-lucide="type" style="width:22px;height:22px;color:var(--primary)"></i></span><p>Add Text</p></div>
                    <div class="feature-item"><span><i data-lucide="image" style="width:22px;height:22px;color:var(--primary)"></i></span><p>Images</p></div>
                    <div class="feature-item"><span><i data-lucide="pen-line" style="width:22px;height:22px;color:var(--primary)"></i></span><p>Signatures</p></div>
                    <div class="feature-item"><span><i data-lucide="link" style="width:22px;height:22px;color:var(--primary)"></i></span><p>Links</p></div>
                </div>
                
            </article>
        </div>
    </main>
    <div id="editorScreen">
        <header class="header">
            <a href="/" class="logo"><div class="logo-icon"><i data-lucide="file-pen" style="width:24px;height:24px;color:white"></i></div><div class="logo-text">PDF <span>Editor</span></div></a>
            <div style="display:flex;gap:10px">
                <button class="btn btn-ghost" onclick="location.reload()"><i data-lucide="folder-plus" style="width:18px;height:18px"></i> <span class="btn-text">New</span></button>
                <button class="btn btn-success" onclick="downloadPDF()"><i data-lucide="download" style="width:18px;height:18px"></i> <span class="btn-text">Download</span></button>
            </div>
        </header>
        <nav class="toolbar">
            <button class="tool-btn" id="btnSelect" onclick="setTool('select')"><i data-lucide="mouse-pointer-2" style="width:16px;height:16px"></i> <span class="tool-text">Select</span></button>
            <button class="tool-btn active" id="btnText" onclick="setTool('text')"><i data-lucide="type" style="width:16px;height:16px"></i> <span class="tool-text">Text</span></button>
            <button class="tool-btn" id="btnLink" onclick="setTool('link')"><i data-lucide="link" style="width:16px;height:16px"></i> <span class="tool-text">Link</span></button>
            <div class="divider"></div>
            <button class="tool-btn" id="btnDraw" onclick="setTool('draw')"><i data-lucide="pencil" style="width:16px;height:16px"></i> <span class="tool-text">Draw</span></button>
            <button class="tool-btn" id="btnHighlight" onclick="setTool('highlight')"><i data-lucide="highlighter" style="width:16px;height:16px"></i> <span class="tool-text">Highlight</span></button>
            <div class="divider"></div>
            <button class="tool-btn" id="btnRect" onclick="setTool('rect')"><i data-lucide="square" style="width:16px;height:16px"></i> <span class="tool-text">Rect</span></button>
            <button class="tool-btn" id="btnCircle" onclick="setTool('circle')"><i data-lucide="circle" style="width:16px;height:16px"></i> <span class="tool-text">Circle</span></button>
            <button class="tool-btn" id="btnLine" onclick="setTool('line')"><i data-lucide="minus" style="width:16px;height:16px"></i> <span class="tool-text">Line</span></button>
            <div class="divider"></div>
            <button class="tool-btn" onclick="document.getElementById('imgInput').click()"><i data-lucide="image" style="width:16px;height:16px"></i> <span class="tool-text">Image</span></button>
            <button class="tool-btn" onclick="openSigModal()"><i data-lucide="pen-line" style="width:16px;height:16px"></i> <span class="tool-text">Sign</span></button>
            <div class="divider"></div>
            <div class="color-wrap">
                <button class="color-btn" id="colorBtn" style="background:#000" onclick="toggleColor()"></button>
                <div class="color-menu" id="colorMenu"></div>
            </div>
            <select id="fontSizeSelect" onchange="fontSize=parseInt(this.value)">
                <option value="12">12px</option><option value="14">14px</option><option value="16" selected>16px</option><option value="18">18px</option><option value="20">20px</option><option value="24">24px</option><option value="32">32px</option>
            </select>
            <div class="divider"></div>
            <button class="tool-btn" onclick="undo()"><i data-lucide="undo-2" style="width:16px;height:16px"></i></button>
            <button class="tool-btn danger" onclick="delSelected()"><i data-lucide="trash-2" style="width:16px;height:16px"></i></button>
            <div class="page-nav">
                <button class="nav-btn" onclick="zoomOut()"><i data-lucide="minus" style="width:16px;height:16px"></i></button>
                <span class="zoom-info" id="zoomLvl">100%</span>
                <button class="nav-btn" onclick="zoomIn()"><i data-lucide="plus" style="width:16px;height:16px"></i></button>
                <div class="divider"></div>
                <button class="nav-btn" id="prevBtn" onclick="prevPage()"><i data-lucide="chevron-left" style="width:16px;height:16px"></i></button>
                <span class="page-info" id="pageInfo">1/1</span>
                <button class="nav-btn" id="nextBtn" onclick="nextPage()"><i data-lucide="chevron-right" style="width:16px;height:16px"></i></button>
            </div>
        </nav>
        <div class="editor-main">
            <aside class="sidebar" id="sidebar"></aside>
            <section class="canvas-area">
                <div class="canvas-wrap" id="canvasWrap">
                    <canvas id="pdfCanvas"></canvas>
                    <canvas id="editCanvas"></canvas>
                    <div class="selection-rect" id="selRect"></div>
                    <div class="text-overlay" id="textOverlay"><textarea id="textInput"></textarea></div>
                </div>
            </section>
            <div class="link-popup" id="linkPopup">
                <h4><i data-lucide="link" style="width:20px;height:20px;color:var(--primary)"></i> Add Clickable Link</h4>
                <p>Enter the URL you want to link to:</p>
                <input type="url" id="linkUrlInput" placeholder="https://example.com">
                <div class="link-popup-btns">
                    <button class="btn btn-ghost" onclick="cancelLink()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmLink()">Add Link</button>
                </div>
            </div>
            <aside class="right-panel">
                <div class="panel-title">Elements</div>
                <div id="elemList"></div>
                <p id="noElem" style="font-size:11px;color:var(--text-light);text-align:center;padding:18px">No elements yet</p>
                <div class="help-box">
                    <strong>Quick Tips</strong>
                    <ul>
                        <li><strong>Text/Link:</strong> Drag to create</li>
                        <li><strong>Select:</strong> Click & drag to move</li>
                        <li><strong>Resize:</strong> Drag corner handles</li>
                        <li><strong>Delete:</strong> Press Delete key</li>
                    </ul>
                </div>
            </aside>
        </div>
        
    </div>
    <div class="modal-bg" id="sigModal">
        <div class="modal">
            <h3><i data-lucide="pen-line" style="width:22px;height:22px;color:var(--primary)"></i> Draw Your Signature</h3>
            <canvas id="sigCanvas" class="sig-canvas"></canvas>
            <div class="modal-btns">
                <button class="btn btn-ghost" onclick="clearSig()">Clear</button>
                <button class="btn btn-primary" onclick="addSig()">Add Signature</button>
            </div>
        </div>
    </div>
    <input type="file" id="imgInput" accept="image/*" style="display:none">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        let pdfDoc,pdfFile,curPage=1,totalPages=0,scale=1.5,tool='text',color='#000000',fontSize=16,stroke=2,elems={},curElems=[],selIdx=null,undoStack=[],isDrawing=false,startX=0,startY=0,curX=0,curY=0,isDragging=false,dragOffX=0,dragOffY=0,pendingLink=null,isResizing=false,resizeHandle=null,resizeStartX=0,resizeStartY=0,resizeOriginal=null;
        const HANDLE_SIZE=10,pdfC=document.getElementById('pdfCanvas'),pdfCtx=pdfC.getContext('2d'),editC=document.getElementById('editCanvas'),editCtx=editC.getContext('2d'),selRect=document.getElementById('selRect'),colors=['#000000','#333333','#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#6366f1','#ffffff'];
        document.getElementById('colorMenu').innerHTML='<div class="color-grid">'+colors.map(c=>`<div class="color-swatch" style="background:${c};${c==='#ffffff'?'border:1px solid var(--border)':''}" onclick="pickColor('${c}')"></div>`).join('')+'</div>';
        function pickColor(c){color=c;document.getElementById('colorBtn').style.background=c;document.getElementById('colorMenu').classList.remove('show')}
        function toggleColor(){document.getElementById('colorMenu').classList.toggle('show')}
        const uploadArea=document.getElementById('uploadArea');
        uploadArea.onclick=()=>document.getElementById('fileInput').click();
        uploadArea.onkeydown=e=>{if(e.key==='Enter'||e.key===' ')document.getElementById('fileInput').click()};
        uploadArea.ondragover=e=>{e.preventDefault();uploadArea.style.borderColor='var(--primary)'};
        uploadArea.ondragleave=()=>uploadArea.style.borderColor='var(--border)';
        uploadArea.ondrop=e=>{e.preventDefault();uploadArea.style.borderColor='var(--border)';if(e.dataTransfer.files[0])loadPDF(e.dataTransfer.files[0])};
        document.getElementById('fileInput').onchange=e=>{if(e.target.files[0])loadPDF(e.target.files[0])};
        async function loadPDF(file){if(file.type!=='application/pdf'){alert('Please select a PDF!');return}showLoad('Loading PDF...');pdfFile=file;try{const buf=await file.arrayBuffer();pdfDoc=await pdfjsLib.getDocument({data:buf}).promise;totalPages=pdfDoc.numPages;document.getElementById('uploadScreen').style.display='none';document.getElementById('editorScreen').style.display='flex';await renderPage(1);await genThumbs();hideLoad();toast('PDF loaded! Start editing.')}catch(err){alert('Error: '+err.message);hideLoad()}}
        async function renderPage(n){if(curElems.length)elems[curPage]=[...curElems];curPage=n;curElems=elems[n]||[];selIdx=null;const pg=await pdfDoc.getPage(n),vp=pg.getViewport({scale});pdfC.width=vp.width;pdfC.height=vp.height;editC.width=vp.width;editC.height=vp.height;await pg.render({canvasContext:pdfCtx,viewport:vp}).promise;redraw();updateInfo()}
        function redraw(){editCtx.clearRect(0,0,editC.width,editC.height);curElems.forEach((el,i)=>drawEl(el,i===selIdx));updateList()}
        function drawEl(el,sel){editCtx.save();if(el.type==='text'){editCtx.font=`${el.fs}px 'DM Sans',sans-serif`;editCtx.fillStyle=el.color;editCtx.textBaseline='top';const words=el.text.split(' ');let line='',y=el.y;const maxW=el.w-4;for(const word of words){const test=line+word+' ';if(editCtx.measureText(test).width>maxW&&line){editCtx.fillText(line.trim(),el.x+2,y);line=word+' ';y+=el.fs+2}else{line=test}}editCtx.fillText(line.trim(),el.x+2,y);if(sel)drawSelectionBox(el.x,el.y,el.w,el.h)}else if(el.type==='link'){if(sel){editCtx.strokeStyle='#7c3aed';editCtx.lineWidth=2;editCtx.strokeRect(el.x,el.y,el.w,el.h);drawResizeHandles(el.x,el.y,el.w,el.h)}else{editCtx.strokeStyle='rgba(124,58,237,0.3)';editCtx.lineWidth=1;editCtx.setLineDash([4,4]);editCtx.strokeRect(el.x,el.y,el.w,el.h);editCtx.setLineDash([])}editCtx.font='12px Arial';editCtx.fillStyle='rgba(124,58,237,0.5)';editCtx.fillText('üîó',el.x+2,el.y+14)}else if(el.type==='draw'||el.type==='highlight'){if(el.path&&el.path.length>1){editCtx.beginPath();editCtx.moveTo(el.path[0].x,el.path[0].y);el.path.forEach(p=>editCtx.lineTo(p.x,p.y));editCtx.strokeStyle=el.type==='highlight'?'rgba(255,235,59,0.5)':el.color;editCtx.lineWidth=el.type==='highlight'?20:el.sw;editCtx.lineCap='round';editCtx.lineJoin='round';editCtx.stroke();if(sel){const b=getBounds(el);if(b)drawSelectionBox(b.x,b.y,b.w,b.h)}}}else if(el.type==='rect'){editCtx.strokeStyle=el.color;editCtx.lineWidth=el.sw;editCtx.strokeRect(el.x,el.y,el.w,el.h);if(sel)drawSelectionBox(el.x,el.y,el.w,el.h)}else if(el.type==='circle'){editCtx.beginPath();editCtx.ellipse(el.x+el.w/2,el.y+el.h/2,Math.abs(el.w/2),Math.abs(el.h/2),0,0,Math.PI*2);editCtx.strokeStyle=el.color;editCtx.lineWidth=el.sw;editCtx.stroke();if(sel)drawSelectionBox(el.x,el.y,el.w,el.h)}else if(el.type==='line'){editCtx.beginPath();editCtx.moveTo(el.x,el.y);editCtx.lineTo(el.x+el.w,el.y+el.h);editCtx.strokeStyle=el.color;editCtx.lineWidth=el.sw;editCtx.stroke();if(sel){editCtx.fillStyle='#7c3aed';editCtx.fillRect(el.x-HANDLE_SIZE/2,el.y-HANDLE_SIZE/2,HANDLE_SIZE,HANDLE_SIZE);editCtx.fillRect(el.x+el.w-HANDLE_SIZE/2,el.y+el.h-HANDLE_SIZE/2,HANDLE_SIZE,HANDLE_SIZE);editCtx.strokeStyle='white';editCtx.lineWidth=1;editCtx.strokeRect(el.x-HANDLE_SIZE/2,el.y-HANDLE_SIZE/2,HANDLE_SIZE,HANDLE_SIZE);editCtx.strokeRect(el.x+el.w-HANDLE_SIZE/2,el.y+el.h-HANDLE_SIZE/2,HANDLE_SIZE,HANDLE_SIZE)}}else if(el.type==='image'&&el.img){editCtx.drawImage(el.img,el.x,el.y,el.w,el.h);if(sel)drawSelectionBox(el.x,el.y,el.w,el.h)}editCtx.restore()}
        function drawSelectionBox(x,y,w,h){editCtx.save();editCtx.strokeStyle='#7c3aed';editCtx.lineWidth=2;editCtx.setLineDash([4,4]);editCtx.strokeRect(x,y,w,h);editCtx.setLineDash([]);editCtx.restore();drawResizeHandles(x,y,w,h)}
        function drawResizeHandles(x,y,w,h){editCtx.save();editCtx.fillStyle='#7c3aed';editCtx.strokeStyle='white';editCtx.lineWidth=1;const hs=HANDLE_SIZE,handles=[{hx:x-hs/2,hy:y-hs/2},{hx:x+w-hs/2,hy:y-hs/2},{hx:x-hs/2,hy:y+h-hs/2},{hx:x+w-hs/2,hy:y+h-hs/2},{hx:x+w/2-hs/2,hy:y-hs/2},{hx:x+w/2-hs/2,hy:y+h-hs/2},{hx:x-hs/2,hy:y+h/2-hs/2},{hx:x+w-hs/2,hy:y+h/2-hs/2}];handles.forEach(({hx,hy})=>{editCtx.fillRect(hx,hy,hs,hs);editCtx.strokeRect(hx,hy,hs,hs)});editCtx.restore()}
        function getResizeHandle(el,mx,my){const b=getBounds(el);if(!b)return null;const{x,y,w,h}=b,hs=HANDLE_SIZE,tolerance=hs/2+2;if(Math.abs(mx-x)<tolerance&&Math.abs(my-y)<tolerance)return'tl';if(Math.abs(mx-(x+w))<tolerance&&Math.abs(my-y)<tolerance)return'tr';if(Math.abs(mx-x)<tolerance&&Math.abs(my-(y+h))<tolerance)return'bl';if(Math.abs(mx-(x+w))<tolerance&&Math.abs(my-(y+h))<tolerance)return'br';if(Math.abs(mx-(x+w/2))<tolerance&&Math.abs(my-y)<tolerance)return't';if(Math.abs(mx-(x+w/2))<tolerance&&Math.abs(my-(y+h))<tolerance)return'b';if(Math.abs(mx-x)<tolerance&&Math.abs(my-(y+h/2))<tolerance)return'l';if(Math.abs(mx-(x+w))<tolerance&&Math.abs(my-(y+h/2))<tolerance)return'r';if(el.type==='line'){if(Math.abs(mx-el.x)<tolerance&&Math.abs(my-el.y)<tolerance)return'lineStart';if(Math.abs(mx-(el.x+el.w))<tolerance&&Math.abs(my-(el.y+el.h))<tolerance)return'lineEnd'}return null}
        function getResizeCursor(handle){const cursors={'tl':'nwse-resize','br':'nwse-resize','tr':'nesw-resize','bl':'nesw-resize','t':'ns-resize','b':'ns-resize','l':'ew-resize','r':'ew-resize','lineStart':'move','lineEnd':'move'};return cursors[handle]||'default'}
        function getBounds(el){if(el.type==='draw'||el.type==='highlight'){if(!el.path||!el.path.length)return null;let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;el.path.forEach(p=>{minX=Math.min(minX,p.x);minY=Math.min(minY,p.y);maxX=Math.max(maxX,p.x);maxY=Math.max(maxY,p.y)});return{x:minX,y:minY,w:maxX-minX,h:maxY-minY}}return{x:el.x,y:el.y,w:el.w,h:el.h}}
        function updateList(){const list=document.getElementById('elemList'),noEl=document.getElementById('noElem');list.innerHTML='';if(!curElems.length){noEl.style.display='block';return}noEl.style.display='none';const icons={text:'T',link:'üîó',draw:'‚úé',highlight:'H',rect:'‚ñ¢',circle:'‚óã',line:'‚Äî',image:'‚ñ£'};curElems.forEach((el,i)=>{const d=document.createElement('div');d.className='element-item'+(i===selIdx?' selected':'');d.innerHTML=`<span style="font-weight:600">${icons[el.type]||'‚Ä¢'} ${el.type}</span><button class="del-btn" onclick="event.stopPropagation();delEl(${i})">√ó</button>`;d.onclick=()=>{selIdx=i;redraw()};list.appendChild(d)})}
        async function genThumbs(){const sb=document.getElementById('sidebar');sb.innerHTML='';for(let i=1;i<=totalPages;i++){const pg=await pdfDoc.getPage(i),vp=pg.getViewport({scale:0.15}),c=document.createElement('canvas');c.width=vp.width;c.height=vp.height;await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;const th=document.createElement('div');th.className='thumb'+(i===1?' active':'');th.dataset.p=i;th.innerHTML=`<img src="${c.toDataURL()}" alt="Page ${i}"><div class="thumb-num">${i}</div>`;th.onclick=()=>renderPage(i);sb.appendChild(th)}}
        function updateInfo(){document.getElementById('pageInfo').textContent=`${curPage}/${totalPages}`;document.getElementById('prevBtn').disabled=curPage<=1;document.getElementById('nextBtn').disabled=curPage>=totalPages;document.querySelectorAll('.thumb').forEach(t=>t.classList.toggle('active',+t.dataset.p===curPage))}
        editC.onmousedown=e=>{const r=editC.getBoundingClientRect();startX=e.clientX-r.left;startY=e.clientY-r.top;hideOverlays();if(tool==='select'){if(selIdx!==null){const el=curElems[selIdx],handle=getResizeHandle(el,startX,startY);if(handle){isResizing=true;resizeHandle=handle;resizeStartX=startX;resizeStartY=startY;resizeOriginal=JSON.parse(JSON.stringify(el));if(el.path)resizeOriginal.path=el.path.map(p=>({...p}));saveUndo();return}}let found=null;for(let i=curElems.length-1;i>=0;i--){if(hitTest(curElems[i],startX,startY)){found=i;break}}if(found!==null){selIdx=found;isDragging=true;const el=curElems[selIdx],b=getBounds(el);dragOffX=startX-b.x;dragOffY=startY-b.y;saveUndo()}else{selIdx=null}redraw()}else if(tool==='draw'||tool==='highlight'){isDrawing=true;saveUndo();curElems.push({type:tool,path:[{x:startX,y:startY}],color,sw:stroke})}else{isDrawing=true;selRect.style.display='block';selRect.style.left=startX+'px';selRect.style.top=startY+'px';selRect.style.width='0';selRect.style.height='0'}};
        editC.onmousemove=e=>{const r=editC.getBoundingClientRect();curX=e.clientX-r.left;curY=e.clientY-r.top;if(isResizing&&selIdx!==null){const el=curElems[selIdx],dx=curX-resizeStartX,dy=curY-resizeStartY;resizeElement(el,resizeHandle,dx,dy,resizeOriginal);redraw()}else if(isDragging&&selIdx!==null){const el=curElems[selIdx];if(el.type==='draw'||el.type==='highlight'){const b=getBounds(el),dx=curX-dragOffX-b.x,dy=curY-dragOffY-b.y;el.path.forEach(p=>{p.x+=dx;p.y+=dy});dragOffX=curX-b.x-dx;dragOffY=curY-b.y-dy}else{el.x=curX-dragOffX;el.y=curY-dragOffY}redraw()}else if(isDrawing){if(tool==='draw'||tool==='highlight'){curElems[curElems.length-1].path.push({x:curX,y:curY});redraw()}else{const w=curX-startX,h=curY-startY;selRect.style.left=(w<0?curX:startX)+'px';selRect.style.top=(h<0?curY:startY)+'px';selRect.style.width=Math.abs(w)+'px';selRect.style.height=Math.abs(h)+'px'}}else if(tool==='select'){let cursor='default';if(selIdx!==null){const handle=getResizeHandle(curElems[selIdx],curX,curY);if(handle)cursor=getResizeCursor(handle)}if(cursor==='default'){for(let i=curElems.length-1;i>=0;i--){if(hitTest(curElems[i],curX,curY)){cursor='move';break}}}editC.style.cursor=cursor}};
        editC.onmouseup=()=>{if(isResizing){isResizing=false;resizeHandle=null;resizeOriginal=null;redraw();return}if(isDrawing){isDrawing=false;selRect.style.display='none';if(tool!=='draw'&&tool!=='highlight'){const x=Math.min(startX,curX),y=Math.min(startY,curY),w=Math.abs(curX-startX),h=Math.abs(curY-startY);if(w>10&&h>10){if(tool==='text')showTextInput(x,y,w,h);else if(tool==='link')showLinkPopup(x,y,w,h);else if(tool==='rect'){saveUndo();curElems.push({type:'rect',x,y,w,h,color,sw:stroke});selIdx=curElems.length-1;redraw()}else if(tool==='circle'){saveUndo();curElems.push({type:'circle',x,y,w,h,color,sw:stroke});selIdx=curElems.length-1;redraw()}else if(tool==='line'){saveUndo();curElems.push({type:'line',x:startX,y:startY,w:curX-startX,h:curY-startY,color,sw:stroke});selIdx=curElems.length-1;redraw()}}}else{redraw()}}isDragging=false};
        editC.ontouchstart=e=>{e.preventDefault();const touch=e.touches[0],mouseEvent=new MouseEvent('mousedown',{clientX:touch.clientX,clientY:touch.clientY});editC.dispatchEvent(mouseEvent)};
        editC.ontouchmove=e=>{e.preventDefault();const touch=e.touches[0],mouseEvent=new MouseEvent('mousemove',{clientX:touch.clientX,clientY:touch.clientY});editC.dispatchEvent(mouseEvent)};
        editC.ontouchend=()=>{editC.dispatchEvent(new MouseEvent('mouseup'))};
        function resizeElement(el,handle,dx,dy,orig){const minSize=20;if(el.type==='line'){if(handle==='lineStart'){el.x=orig.x+dx;el.y=orig.y+dy;el.w=orig.w-dx;el.h=orig.h-dy}else if(handle==='lineEnd'){el.w=orig.w+dx;el.h=orig.h+dy}return}if(el.type==='draw'||el.type==='highlight'){const origBounds={x:Math.min(...orig.path.map(p=>p.x)),y:Math.min(...orig.path.map(p=>p.y)),w:Math.max(...orig.path.map(p=>p.x))-Math.min(...orig.path.map(p=>p.x)),h:Math.max(...orig.path.map(p=>p.y))-Math.min(...orig.path.map(p=>p.y))};let newX=origBounds.x,newY=origBounds.y,newW=origBounds.w,newH=origBounds.h;if(handle.includes('l')){newX=origBounds.x+dx;newW=origBounds.w-dx}if(handle.includes('r')||handle==='r'){newW=origBounds.w+dx}if(handle.includes('t')&&handle!=='tr'){newY=origBounds.y+dy;newH=origBounds.h-dy}if(handle==='t'){newY=origBounds.y+dy;newH=origBounds.h-dy}if(handle.includes('b')||handle==='b'){newH=origBounds.h+dy}if(handle==='tr'){newW=origBounds.w+dx;newY=origBounds.y+dy;newH=origBounds.h-dy}if(newW<minSize)newW=minSize;if(newH<minSize)newH=minSize;const scaleX=newW/(origBounds.w||1),scaleY=newH/(origBounds.h||1);el.path=orig.path.map(p=>({x:newX+(p.x-origBounds.x)*scaleX,y:newY+(p.y-origBounds.y)*scaleY}));return}let newX=orig.x,newY=orig.y,newW=orig.w,newH=orig.h;switch(handle){case'tl':newX=orig.x+dx;newY=orig.y+dy;newW=orig.w-dx;newH=orig.h-dy;break;case'tr':newY=orig.y+dy;newW=orig.w+dx;newH=orig.h-dy;break;case'bl':newX=orig.x+dx;newW=orig.w-dx;newH=orig.h+dy;break;case'br':newW=orig.w+dx;newH=orig.h+dy;break;case't':newY=orig.y+dy;newH=orig.h-dy;break;case'b':newH=orig.h+dy;break;case'l':newX=orig.x+dx;newW=orig.w-dx;break;case'r':newW=orig.w+dx;break}if(newW<minSize){newW=minSize;if(handle.includes('l'))newX=orig.x+orig.w-minSize}if(newH<minSize){newH=minSize;if(handle.includes('t'))newY=orig.y+orig.h-minSize}el.x=newX;el.y=newY;el.w=newW;el.h=newH}
        function hitTest(el,x,y){const b=getBounds(el);if(!b)return false;return x>=b.x-5&&x<=b.x+b.w+5&&y>=b.y-5&&y<=b.y+b.h+5}
        function hideOverlays(){document.getElementById('textOverlay').classList.remove('show');document.getElementById('linkPopup').classList.remove('show')}
        function showTextInput(x,y,w,h){const overlay=document.getElementById('textOverlay'),input=document.getElementById('textInput');overlay.style.left=x+'px';overlay.style.top=y+'px';overlay.classList.add('show');input.style.width=w+'px';input.style.height=h+'px';input.style.fontSize=fontSize+'px';input.style.color=color;input.value='';input.dataset.x=x;input.dataset.y=y;input.dataset.w=w;input.dataset.h=h;input.focus()}
        document.getElementById('textInput').onblur=function(){const text=this.value.trim();if(text){saveUndo();curElems.push({type:'text',text,x:+this.dataset.x,y:+this.dataset.y,w:+this.dataset.w,h:+this.dataset.h,color,fs:fontSize});selIdx=curElems.length-1;redraw()}document.getElementById('textOverlay').classList.remove('show')};
        document.getElementById('textInput').onkeydown=e=>{if(e.key==='Escape')document.getElementById('textOverlay').classList.remove('show')};
        function showLinkPopup(x,y,w,h){pendingLink={x,y,w,h};document.getElementById('linkPopup').classList.add('show');const input=document.getElementById('linkUrlInput');input.value='https://';input.focus();input.setSelectionRange(8,8);redraw();editCtx.strokeStyle='#7c3aed';editCtx.lineWidth=2;editCtx.setLineDash([6,4]);editCtx.strokeRect(x,y,w,h);editCtx.setLineDash([])}
        function confirmLink(){const url=document.getElementById('linkUrlInput').value.trim();if(!url||url==='https://'){alert('Please enter a URL!');return}if(pendingLink){saveUndo();curElems.push({type:'link',url,x:pendingLink.x,y:pendingLink.y,w:pendingLink.w,h:pendingLink.h});selIdx=curElems.length-1;toast('Link added! Clickable in PDF.')}pendingLink=null;document.getElementById('linkPopup').classList.remove('show');redraw()}
        function cancelLink(){pendingLink=null;document.getElementById('linkPopup').classList.remove('show');redraw()}
        document.getElementById('linkUrlInput').onkeydown=e=>{if(e.key==='Enter')confirmLink();if(e.key==='Escape')cancelLink()};
        function setTool(t){tool=t;document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));const btn=document.getElementById('btn'+t.charAt(0).toUpperCase()+t.slice(1));if(btn)btn.classList.add('active');editC.style.cursor=t==='select'?'default':'crosshair'}
        document.getElementById('imgInput').onchange=e=>{if(!e.target.files[0])return;const rd=new FileReader();rd.onload=ev=>{const img=new Image();img.onload=()=>{let w=img.width,h=img.height;const mx=200;if(w>mx||h>mx){const r=mx/Math.max(w,h);w*=r;h*=r}saveUndo();curElems.push({type:'image',img,src:ev.target.result,x:editC.width/2-w/2,y:editC.height/2-h/2,w,h});selIdx=curElems.length-1;setTool('select');redraw()};img.src=ev.target.result};rd.readAsDataURL(e.target.files[0]);e.target.value=''};
        let sigCtx,sigDraw=false;
        function openSigModal(){document.getElementById('sigModal').classList.add('show');const c=document.getElementById('sigCanvas');sigCtx=c.getContext('2d');c.width=c.offsetWidth;c.height=c.offsetHeight;sigCtx.fillStyle='white';sigCtx.fillRect(0,0,c.width,c.height);let lx,ly;c.onmousedown=e=>{sigDraw=true;[lx,ly]=[e.offsetX,e.offsetY]};c.onmousemove=e=>{if(!sigDraw)return;sigCtx.beginPath();sigCtx.moveTo(lx,ly);sigCtx.lineTo(e.offsetX,e.offsetY);sigCtx.strokeStyle='#000';sigCtx.lineWidth=2;sigCtx.lineCap='round';sigCtx.stroke();[lx,ly]=[e.offsetX,e.offsetY]};c.onmouseup=c.onmouseleave=()=>sigDraw=false;c.ontouchstart=e=>{e.preventDefault();sigDraw=true;const rect=c.getBoundingClientRect();lx=e.touches[0].clientX-rect.left;ly=e.touches[0].clientY-rect.top};c.ontouchmove=e=>{e.preventDefault();if(!sigDraw)return;const rect=c.getBoundingClientRect(),x=e.touches[0].clientX-rect.left,y=e.touches[0].clientY-rect.top;sigCtx.beginPath();sigCtx.moveTo(lx,ly);sigCtx.lineTo(x,y);sigCtx.strokeStyle='#000';sigCtx.lineWidth=2;sigCtx.lineCap='round';sigCtx.stroke();[lx,ly]=[x,y]};c.ontouchend=()=>sigDraw=false}
        function clearSig(){const c=document.getElementById('sigCanvas');sigCtx.fillStyle='white';sigCtx.fillRect(0,0,c.width,c.height)}
        function addSig(){const c=document.getElementById('sigCanvas'),url=c.toDataURL(),img=new Image();img.onload=()=>{saveUndo();curElems.push({type:'image',img,src:url,x:editC.width/2-100,y:editC.height/2-40,w:200,h:80});selIdx=curElems.length-1;setTool('select');redraw()};img.src=url;document.getElementById('sigModal').classList.remove('show')}
        function delSelected(){if(selIdx!==null){saveUndo();curElems.splice(selIdx,1);selIdx=null;redraw()}}
        function delEl(i){saveUndo();curElems.splice(i,1);selIdx=null;redraw()}
        function saveUndo(){undoStack.push(JSON.stringify(curElems));if(undoStack.length>30)undoStack.shift()}
        function undo(){if(undoStack.length){curElems=JSON.parse(undoStack.pop());curElems.forEach(el=>{if(el.type==='image'&&el.src){const img=new Image();img.src=el.src;el.img=img}});selIdx=null;redraw()}}
        function prevPage(){if(curPage>1)renderPage(curPage-1)}
        function nextPage(){if(curPage<totalPages)renderPage(curPage+1)}
        function zoomIn(){scale=Math.min(scale+0.25,3);document.getElementById('zoomLvl').textContent=Math.round(scale/1.5*100)+'%';renderPage(curPage)}
        function zoomOut(){scale=Math.max(scale-0.25,0.5);document.getElementById('zoomLvl').textContent=Math.round(scale/1.5*100)+'%';renderPage(curPage)}
        async function downloadPDF(){showLoad('Creating PDF...');elems[curPage]=[...curElems];try{const buf=await pdfFile.arrayBuffer(),doc=await PDFLib.PDFDocument.load(buf);for(let p=1;p<=totalPages;p++){const els=elems[p]||[];if(!els.length)continue;const pg=doc.getPages()[p-1],{width,height}=pg.getSize(),tc=document.createElement('canvas'),tpg=await pdfDoc.getPage(p),tvp=tpg.getViewport({scale:1});tc.width=tvp.width;tc.height=tvp.height;const tctx=tc.getContext('2d'),rt=1/scale;for(const el of els){tctx.save();if(el.type==='text'){tctx.font=`${el.fs*rt}px 'DM Sans',sans-serif`;tctx.fillStyle=el.color;tctx.textBaseline='top';const words=el.text.split(' ');let line='',y=el.y*rt;const maxW=el.w*rt-4;for(const word of words){const test=line+word+' ';if(tctx.measureText(test).width>maxW&&line){tctx.fillText(line.trim(),el.x*rt+2,y);line=word+' ';y+=(el.fs+2)*rt}else{line=test}}tctx.fillText(line.trim(),el.x*rt+2,y)}else if(el.type==='link'){}else if((el.type==='draw'||el.type==='highlight')&&el.path&&el.path.length>1){tctx.beginPath();tctx.moveTo(el.path[0].x*rt,el.path[0].y*rt);el.path.forEach(pt=>tctx.lineTo(pt.x*rt,pt.y*rt));tctx.strokeStyle=el.type==='highlight'?'rgba(255,235,59,0.5)':el.color;tctx.lineWidth=(el.type==='highlight'?20:el.sw)*rt;tctx.lineCap='round';tctx.stroke()}else if(el.type==='rect'){tctx.strokeStyle=el.color;tctx.lineWidth=el.sw*rt;tctx.strokeRect(el.x*rt,el.y*rt,el.w*rt,el.h*rt)}else if(el.type==='circle'){tctx.beginPath();tctx.ellipse((el.x+el.w/2)*rt,(el.y+el.h/2)*rt,Math.abs(el.w/2)*rt,Math.abs(el.h/2)*rt,0,0,Math.PI*2);tctx.strokeStyle=el.color;tctx.lineWidth=el.sw*rt;tctx.stroke()}else if(el.type==='line'){tctx.beginPath();tctx.moveTo(el.x*rt,el.y*rt);tctx.lineTo((el.x+el.w)*rt,(el.y+el.h)*rt);tctx.strokeStyle=el.color;tctx.lineWidth=el.sw*rt;tctx.stroke()}else if(el.type==='image'&&el.src){await new Promise(res=>{const im=new Image();im.onload=()=>{tctx.drawImage(im,el.x*rt,el.y*rt,el.w*rt,el.h*rt);res()};im.onerror=res;im.src=el.src})}tctx.restore()}const png=await doc.embedPng(tc.toDataURL('image/png'));pg.drawImage(png,{x:0,y:0,width,height});for(const el of els){if(el.type==='link'){const rt=1/scale,x1=el.x*rt*(width/tvp.width),y1=height-(el.y*rt*(height/tvp.height)),x2=(el.x+el.w)*rt*(width/tvp.width),y2=height-((el.y+el.h)*rt*(height/tvp.height)),linkAnnotation=pg.doc.context.obj({Type:'Annot',Subtype:'Link',Rect:[x1,y2,x2,y1],Border:[0,0,0],A:{Type:'Action',S:'URI',URI:PDFLib.PDFString.of(el.url)}}),linkRef=pg.doc.context.register(linkAnnotation),annots=pg.node.lookup(PDFLib.PDFName.of('Annots'));if(annots){annots.push(linkRef)}else{pg.node.set(PDFLib.PDFName.of('Annots'),pg.doc.context.obj([linkRef]))}}}}const bytes=await doc.save(),blob=new Blob([bytes],{type:'application/pdf'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download='edited_'+pdfFile.name;a.click();URL.revokeObjectURL(url);hideLoad();toast('PDF downloaded!')}catch(err){console.error(err);alert('Error: '+err.message);hideLoad()}}
        function showLoad(t){document.getElementById('loadingText').textContent=t;document.getElementById('loading').classList.add('show')}
        function hideLoad(){document.getElementById('loading').classList.remove('show')}
        function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
        document.onclick=e=>{if(!e.target.closest('.color-wrap'))document.getElementById('colorMenu').classList.remove('show');if(e.target.classList.contains('modal-bg'))e.target.classList.remove('show')};
        document.onkeydown=e=>{if(e.key==='Delete'&&selIdx!==null&&!['INPUT','TEXTAREA'].includes(document.activeElement.tagName))delSelected();if(e.ctrlKey&&e.key==='z'){e.preventDefault();undo()}if(e.key==='Escape')hideOverlays()};
        lucide.createIcons();
    </script>
</body>
</html>